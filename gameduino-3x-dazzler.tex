\documentclass{article}

\usepackage{bytefield}
\usepackage{booktabs}
\usepackage{fancyhdr}
\usepackage{float}
\usepackage{graphicx}
\usepackage{helvet}
\usepackage{hyperref}
\usepackage{tabularx}
\usepackage{xcolor}
\usepackage{wasysym}
\usepackage{color, colortbl}

\usepackage{listings}
\usepackage{tikz}
\usepackage{tikz-dimline}

\usetikzlibrary{shapes,arrows,positioning,fit}

\usepackage{makeidx}         % allows index generation
\makeindex

\lstset{frame=tblr,
  rulecolor=\color{lightgray},
  language=Java,
  aboveskip=5mm,
  belowskip=5mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle=\linespread{1.0}\small\ttfamily,
  numbers=none,
  % numberstyle=\tiny\color{gray},
  % keywordstyle=\color{blue},
  % commentstyle=\color{dkgreen},
  % stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}

\usepackage{framed}     % These needed for the code formatter
\usepackage{color}
\usepackage{fancyvrb}

% Use helvetica (sans) by default
\renewcommand{\familydefault}{\sfdefault}

% Greenish links
\hypersetup{
  colorlinks=true,
  linkcolor=blue!50!red,
  urlcolor=blue!50!red
}

\setlength{\headheight}{40pt}
\setlength{\headsep}{0.2in}

\pagestyle{fancy}
\lhead{\includegraphics[width=0.2\textwidth]{img/logo}}
\chead{Gameduino 3X Dazzler}
\rhead{\thepage}
\cfoot{\textcopyright \ \the\year \ \ Excamera Labs}
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0.5pt}

\usepackage{array}
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

\usepackage{setspace}

\newcommand{\device}{Gameduino 3X Dazzler}
\newcommand{\dev}{Dazzler}

\newcommand{\eg}[1]{
\begin{framed}
\input{code/#1.inc}
\end{framed}
}

\newcommand{\heavyline}{\specialrule{1pt}{1pt}{1pt}}
\newcommand{\png}[1]{
\begin{figure}[H]
\begin{center}
\includegraphics[width=0.75\textwidth]{#1}
\end{center}
\end{figure}
}
\newcommand{\pngw}[2]{
\begin{figure}[H]
\begin{center}
\includegraphics[width=#2\textwidth]{#1}
\end{center}
\end{figure}
}

\newcommand{\mach}[1]{\texttt{\textbf{#1}}}
\newcommand{\gap}{\vspace{10pt}}

\input{pyg.tex}

\begin{document}

\newpage
\begin{center}
\includegraphics[width=1.00\textwidth]{img/gameduino-3x-dazzler/gameduino-3x-dazzler-main}
Last updated on \today
\end{center}
\tableofcontents

\newpage

\setlength{\parindent}{0mm}
\setlength{\parskip}{1mm}
\setstretch{1.4}

\section{Overview}

\png{img/gameduino-3x-dazzler/module}

The \device{} outputs HD picture and sound to any HDMI display.

It is available as a core module, and as an Arduino-compatible shield.

\subsection{Features}

The core module has the following features:

\begin{itemize}
\item Powerful BT815 embedded GPU with 24 bit color
\item HDMI encoding and system management handled by Xilinx Spartan-6 LX9 FPGA
\item 2 $\times$ 8 Megabyte flash
\item HDMI video output at 1280x720 @ 60 Hz (720p), audio output at 48 KHz
\item All features accessible via SPI interface
\item Single 5V supply; onboard regulation to 3.3V and 1.2V
\end{itemize}

\noindent
The shield adds:
\begin{itemize}
\item a level shifter so all inputs are 5V tolerant
\item a microSD card slot
\item 2 Wii Classic ports, both continuously scanned by the Dazzler
\item optional headers for standard serial and JTAG connectors
\end{itemize}

\png{img/gameduino-3x-dazzler/rot-0182}

\newpage
\section{Getting Started}

On power-up, the \dev{} displays a boot screen like this:

\pngw{img/gameduino-3x-dazzler/boot}{1.0}

The code on the left is the module's serial number. \index{serial number}
The center code is the firmware version. \index{firmware version}
On the right is the firmware build date.

\pngw{img/gameduino-3x-dazzler/helloworld}{1.0}

\subsection{WII controllers}

XXX

\section{SPI interfaces}

\subsection{Dazzler interface}

The Dazzler has its own SPI interface distinct from the BT815 and microSD SPI interfaces.
This interface controls the Dazzler at a system level and allows firmware updates.

SPI writes to the Dazzler use the following format. Additional bytes are ignored.

\gap
\begin{bytefield}[endianness=big,bitwidth=3.2em]{10}
\bitbox[]{2}{+0}\bitbox{8}{command} \\
\bitbox[]{2}{+1}\bitbox{8}{N} \\
\end{bytefield}

SPI reads from the Dazzler use the following format.

\gap
\begin{bytefield}[endianness=big,bitwidth=3.2em]{10}
  \bitbox[]{2}{+0} \bitbox{8}{ID byte: \mach{0xDA}} \\
  \bitbox[]{2}{+1} \bitbox{8}{status byte} \\

  \bitbox[]{2}{+2} \bitbox[lrt]{8}{} \\
  \bitbox[]{2}{..} \bitbox[lr]{8}{Player 1 joystick} \\
  \bitbox[]{2}{+7} \bitbox[lrb]{8}{} \\

  \bitbox[]{2}{..} \bitbox[lr]{8}{} \\

  \bitbox[]{2}{+14} \bitbox[lrt]{8}{} \\
  \bitbox[]{2}{..}  \bitbox[lr]{8}{Player 2 joystick} \\
  \bitbox[]{2}{+19} \bitbox[lrb]{8}{} \\
\end{bytefield}

The status byte is \mach{0xff} while the Dazzler is busy processing a command.
The status byte is \mach{0x00}
when the Dazzler is ready to accept a command.

The following commands are supported:

\gap
\begin{tabular}{ll}

\mach{0x40}	& Reset the BT815 \\
\mach{0x41}	& Boot from slot \textbf{N} \\
\mach{0x42}	& Load slot \textbf{N} from file \mach{image.dazzler} on microSD \\

\end{tabular}
\gap

All other byte values are ignored.

The two 6-byte joystick fields follow the Wii Classic controller bit definitions:

\gap
\begin{bytefield}[endianness=big,bitwidth=3.2em]{10}
%\bitheader{0-7} \\
\bitbox[]{2}{+0} \bitbox{2}{RX[4:3]} \bitbox{6}{LX[5:0]}\\
\bitbox[]{2}{+1} \bitbox{2}{RX[2:1]} \bitbox{6}{LY[5:0]}\\
\bitbox[]{2}{+2} \bitbox{1}{RX[0]} \bitbox{2}{LT[4:3]} \bitbox{5}{RY[4:0]}\\
\bitbox[]{2}{+3} \bitbox{3}{LT[2:0]} \bitbox{5}{RT[4:0]}\\
\bitbox[]{2}{+4}
\bitbox{1}{BDR}
\bitbox{1}{BDD}
\bitbox{1}{BLT}
\bitbox{1}{B-}
\bitbox{1}{BH}
\bitbox{1}{B+}
\bitbox{1}{BRT}
\bitbox{1}{1}\\
\bitbox[]{2}{+5}
\bitbox{1}{BZL}
\bitbox{1}{BB}
\bitbox{1}{BY}
\bitbox{1}{BA}
\bitbox{1}{BX}
\bitbox{1}{BZR}
\bitbox{1}{BDL}
\bitbox{1}{BDU}\\
\end{bytefield}

LX,LY are the left Analog Stick X and Y (0-63), RX and RY are the right Analog Stick X and Y (0-31), and LT and RT are the Left and Right Buttons (0 or 31). The left Analog Stick has twice the precision of the other analog values.

BD{L,R,U,D} are the D-Pad direction buttons. B{ZR,ZL,A,B,X,Y,+,H,-} are the discrete buttons. B{LT,RT} are the digital button click of LT and RT. All buttons are 0 when pressed.

The above table and text are taken from \url{https://wiibrew.org/wiki/Wiimote/Extension_Controllers/Classic_Controller_Pro}.

\newpage
\section{Text mode}\label{sec:textmode}

In text mode the Dazzler's onboard hardware directly drives the BT815 GPU 
to produce a high-quality text display on the HDMI output.
The input is a single serial line running at 115200-8-N-1, which feeds the terminal emulation engine.
Text mode can be selected by:
\begin{itemize}
\item The gamepad boot menu
\item The Dazzler serial console
\item The Dazzler SPI register interface
\end{itemize}
All offer an option to start in text mode at boot.

\subsection{ANSI escape codes}

The following standard
\href{https://en.wikipedia.org/wiki/ANSI_escape_code\#CSI_sequences}{CSI codes}
are supported:

\gap\noindent
\begin{tabularx}{\linewidth}{lX}
\heavyline
Code & Effect \\ \heavyline

ESC {[} \emph{n} A & Cursor up \\

ESC {[} \emph{n} B & Cursor down \\

ESC {[} \emph{n} C & Cursor forward \\

ESC {[} \emph{n} D & Cursor back \\

ESC {[} \emph{r;c} H & Cursor position \\

ESC {[} \emph{n} J & Erase display \\

ESC {[} \emph{n} m & Select graphic rendition \\

ESC {[} s & Save cursor position \\

ESC {[} u & Restore cursor position \\ \heavyline
\end{tabularx}
\gap

In addition the following sequences are specific to TermDriver:

\gap
\noindent
\begin{tabularx}{\linewidth}{lX}
\heavyline
Code & Effect \\ \heavyline

ESC {[} \emph{n} h & 
Set display mode.  0 is 80x25, 1 is 128x48, 2 is 96x64 (rotated)
\\

ESC {[} \emph{n} S & Screen-saver.  0 stops video output, 1 restarts video output
\\ \heavyline
\end{tabularx}
\gap

\noindent
For example this C program displays all available foreground and background colors.

\eg{dazzler-color1}

\subsection{High-resolution modes}

In addition to standard 80x25 text mode,
TermDriver supports a higher density 128x48 mode,
and a portrait orientation 96x64 mode.

XXX


\newpage
\section{Pinouts}

\newcommand{\activelow}[1]{$\overline{\mbox{#1}}$}

\subsection{Shield}
The Dazzler Shield follows the standard Arduino Uno pinout.

\gap
\begin{center}
\begin{tabular}{ccl}
\hline
GND	& power & Signal ground \\
5V	& power	& Main supply: 5-9V \\
\\
13	& in	& SPI SCK \\
12	& out	& SPI MISO \\
11	& in	& SPI MOSI \\
\\
10	& in	& DAZZLER SEL \\
9	& in	& SD SEL \\
8	& in	& GPU SEL \\
\\
2	& out	& INTERRUPT \\
1	& in 	& SERIAL IN \\
\hline
\end{tabular}
\end{center}
\gap

All other pins are pass-through.

\subsection{Module}

\pngw{img/gameduino-3x-dazzler/pinout}{0.9}

The \device{} has multiple configurations.
Configurations may be selected using the console.
All configurations use the same assignments for power and console connections.
The factory configuration is the one used for the Dazzler shield.

\gap
\begin{center}
\begin{tabular}{cccl}
\textbf{pin} & \textbf{group} & \textbf{direction} & \textbf{function} \\
\hline
GND	& power & in & Signal ground \\
5V	& power	& in & Main supply: 5-9 V \\
\\
3.3	& power	& out & 3.3 V output \\
\\
1       & console & in    & CONSOLE IN \\
2       & console & out   & CONSOLE OUT \\
\hline
\end{tabular}
\end{center}
\gap

\subsubsection{Gameduino Shield Configuration}
\gap
\begin{center}
\begin{tabular}{cccl}
\textbf{pin} & \textbf{group} & \textbf{direction} & \textbf{function} \\
\hline
8       & Wii     & in/out & P2 SCL \\
9       & Wii     & in     & P2 DETECT \\
10      & Wii     & in/out & P2 SDA \\
11      & Wii     & in/out & P1 SCL \\
12      & Wii     & in     & P1 DETECT \\
13      & Wii     & in/out & P1 SDA \\
\\
17      & microSD & in    & SD MISO \\
18      & microSD & out   & SD SCK \\
19      & microSD & out   & SD MOSI \\
20      & microSD & out   & SD CS \\
\\
22	& SPI     & out   & MISO \\
25	& SPI     & in    & \activelow{GPU SEL} \\
26	& SPI     & in    & \activelow{SD SEL} \\
27	& SPI     & in    & \activelow{DAZZLER SEL} \\
28	& SPI     & in    & MOSI \\
29	& SPI     & in    & SCK \\
\hline
\end{tabular}
\end{center}
\gap

\subsubsection{MC6850 Configuration}
\gap
\begin{center}
\begin{tabular}{ccll}
\textbf{pin} & \textbf{direction} & \textbf{standard} & \textbf{alternate} \\
\hline
3       & in     & Rx Data & \\
4       & in     & Rx CLK & \\
5       & in     & Tx CLK & \\
6       & out    & \activelow{RTS} & \\
7       & out    & Tx Data & \\
8       & out    & \activelow{IRQ} & \\
9       & in     & CS0 & \\
10      & in     & \activelow{CS2} & \\
11      & in     & CS1 & \\
12      & in     & RS & \\
13      & in     & R/\activelow{W} & \\
14      & in     & E & \activelow{E}\\
15      & in/out & D7 & \\
16      & in/out & D6 & \\
17      & in/out & D5 & \\
18      & in/out & D4 & \\
19      & in/out & D3 & \\
20      & in/out & D2 & \\
21      & in/out & D1 & \\
22      & in/out & D0 & \\
23      & in     & \activelow{DCD} & CS7 \\
24      & in     & \activelow{CTS} & CS6 \\
& \\
25      & in     & CS5 & \\
26      & in     & CS4 & \\
27      & in     & CS3 & \\
28      & out    & bus direction & \\
29      & in     & keyboard in & \\
\hline
\end{tabular}
\end{center}
\gap
The MC6850 Configuration emulates a Motorola MC6850. At boot, it behaves identically to a MC6850, with the following enhancements:
\begin{itemize}
\item Transmitted data is send to a 80x25 ANSI TTY emulator, which is displayed on the HDMI output.
See \nameref{sec:textmode} for details of the ANSI code support.
\item \mach{keyboard in} is merged with \mach{Rx Data} and appears to the MC6850 as received data
\end{itemize}

In addition to the MC6850-compatible signals, this configuration also has:

\begin{itemize}

\item \mach{CS$x$} inputs. \mach{CS3} selects direct EVE mode, where reads and writes are transferred directly to the BT815 GPU's SPI port.
\mach{CS4, 5, 6, 7} are optional address selector inputs, programmable at configuration time.
\end{itemize}

There are two functional modes available.
\textbf{standard} mode is fully compatible with the MC6850.
\textbf{alternate} mode is intended for use with Z80-style CPU busses.

\newpage
\section{Internals}

% The block diagram code is probably more verbose than necessary
\begin{center}
\begin{tikzpicture}[
    node distance=0.2cm
  ]
  \tikzstyle{boxed}=[
    draw,
    inner sep=5pt
  ]
  \tikzstyle{rightnode}=[
    text width=2cm
  ]
  \tikzstyle{leftnode}=[
    text width=1.5cm,
    align=center,
    anchor=east
  ]

  % Ordering is important here
  \node [rightnode] (CONSOLE) {CONSOLE};
  \node [rightnode, below=of CONSOLE] (UART) {UART};
  \node [rightnode, below=of UART] (WII) {WII};
  \node [rightnode, below=of WII] (HDMI) {HDMI};
  \node [rightnode, below=of HDMI] (SD) {SD};

  \node [
    boxed,
    xshift=-4cm,
    fit={(CONSOLE) (UART) (WII) (HDMI) (SD)},
    label=center:FPGA
  ] (FPGA) {};

  \node [
    above=0.7cm of FPGA
  ] (JTAG) {JTAG};

  \node [
    leftnode,
    left=1.5cm of FPGA,
    text width=0.7cm,
  ] (SPI) {SPI};
  \node [
    leftnode,
    boxed,
    above=of SPI
  ] (OSC 6 MHz) {OSC \\ 6 MHz};
  \node [
    leftnode,
    boxed,
    below=of SPI
  ] (BOOT FLASH 8M) {BOOT \\ FLASH 8M};

  \node [
    boxed,
    minimum size=2.6cm,
    below=1.5cm of FPGA
  ] (BT815) {BT815};
  \node [
    boxed,
    left=1cm of BT815,
    align=center,
    text width=1.5cm
  ] (FLASH 8M) {FLASH \\ 8M};
  \node [
    right=1cm of BT815,
    align=center,
    text width=2cm,
  ] (CAPACITIVE TOUCH) {CAPACITIVE TOUCH};

  \draw[<->, thick] (JTAG) -- (FPGA);

  \draw[<->, thick] (FPGA.east |- CONSOLE.west) -- (CONSOLE.west);
  \draw[<-, thick] (FPGA.east |- UART.west) -- (UART.west);
  \draw[<->, thick] (FPGA.east |- WII.west) -- (WII.west);
  \draw[->, thick, double] (FPGA.east |- HDMI.west) -- (HDMI.west);
  \draw[<->, thick] (FPGA.east |- SD.west) -- (SD.west);

  \draw[<-, thick] (FPGA.west |- OSC 6 MHz.east) -- (OSC 6 MHz.east);
  \draw[<->, thick] (FPGA.west |- SPI.east) -- (SPI.east);
  \draw[<->, thick] (FPGA.west |- BOOT FLASH 8M.east) -- (BOOT FLASH 8M.east);

  \draw[<->, thick, double] (FPGA) -- (BT815);
  \draw[<->, thick] (FLASH 8M) -- (BT815);
  \draw[<->, thick] (CAPACITIVE TOUCH) -- (BT815);

\end{tikzpicture}
\end{center}

\newpage
\section{Specifications}\label{electrical-characteristics}

\subsection{DC characteristics}
\vspace{10 pt}
{\renewcommand{\arraystretch}{1.2}% for the vertical padding

\begin{tabularx}{\linewidth}{XC{40pt}C{40pt}C{40pt}C{40pt}}
& min & typ & max & units \\ \heavyline

All inputs signals & & & & \\
\hspace{10pt}low voltage & -0.5 & & 0.8 & V \\
\hspace{10pt}high voltage & 2.0 &   & 4.1 & V \\ \hline
Supply voltage        & 4.5 & 5.0 & 9.0 & V                   \\ \hline
Current consumption   & & 180 & & mA                   \\ \hline

\end{tabularx}}
\vspace{10 pt}

\subsection{AC characteristics}
\vspace{10 pt}

{\renewcommand{\arraystretch}{1.2}% for the vertical padding
\begin{tabularx}{\linewidth}{XC{40pt}C{40pt}C{40pt}C{40pt}}
& min & typ & max & units \\ \heavyline

SPI speed                     & & & 36 & Mbps   \index{speed!SPI}\\ \hline
Startup time & & & 270 & ms \\ \hline
Scanout frequency & & 74.25 $\pm$ 0.002\%  & & MHz  \\ \hline
Scanout frame rate & & 60.000 & & Hz  \\ \hline
\end{tabularx}}
\vspace{10 pt}

\subsection{Physical characteristics}
\vspace{10 pt}

{\renewcommand{\arraystretch}{1.2}% for the vertical padding
\begin{tabularx}{\linewidth}{XC{120pt}C{40pt}}
& & units \\ \heavyline

Dimensions (shield)           & 83 $\times$ 53 $\times$ 20 & mm   \index{dimensions}\\ \hline
Weight (shield)               & 32 & g   \index{weight}\\ \hline
Dimensions (module)           & 50 $\times$ 42 $\times$ 8.5 & mm   \index{dimensions}\\ \hline
Weight (module)               & 10 & g   \index{weight}\\ \hline

\end{tabularx}}
\vspace{10 pt}

\subsection{Module mechanical drawing}

All measurements are in mm.

The three mounting holes are designed for M2.5 screws, nuts and standoffs.

\begin{center}
\begin{tikzpicture}[scale=1.7]
\input{dazzler.tikz}
    \coordinate (A) at (0,5);
    \coordinate (B) at (5,5);
    \dimline {(A)}{(B)}{50};
    \coordinate (C) at (5.8,4.2);
    \coordinate (D) at (5.8,0);
    \dimline {(C)}{(D)}{42};

    \coordinate (E) at (0,-0.7);
    \coordinate (F) at (.28,-0.7);
    \coordinate (G) at (4.72,-0.7);
    \coordinate (H) at (5,-0.7);
    \dimline [label style={below=0.5ex,font=\small}] {(F)}{(E)}{2.8};
    \dimline {(G)}{(F)}{44.4};
    \dimline [label style={below=0.5ex,font=\small}]{(H)}{(G)}{2.8};

    \coordinate (I) at (-0.7,0);
    \coordinate (J) at (-0.7,.28);
    \coordinate (K) at (-0.7,3.92);
    \coordinate (L) at (-0.7,4.20);
    \dimline [label style={above=0.5ex,font=\small}] {(I)}{(J)}{2.8};
    \dimline {(J)}{(K)}{36.4};
    \dimline [label style={above=0.5ex,font=\small}]{(K)}{(L)}{2.8};

    \dimline  [label style={above=0.5ex,font=\scriptsize},line style={arrows=dimline reverse-dimline reverse}]
    {(.28-.125,1.3)}{(.28+.125,1.3)}{$\diameter$ 2.5};
\end{tikzpicture}
\end{center}

\newpage
\section{Troubleshooting}

\gap
\begin{tabular}{|l|l|}
\hline
No monitor output after power-up     & $\bullet$ Check HDMI cable and port \\
                                     & $\bullet$ Confirm 5V power present \\
                                     & $\bullet$ Return for replacement \\
\hline
No audio output                      & $\bullet$ Confirm the display has audio output \\
                                     & $\bullet$ Check the display's mute and volume settings \\
\hline
\end{tabular}
\gap

\section{Support information}

Technical and product support is available at
\href{mailto:jamesb@excamera.com}{jamesb@excamera.com}

\device{} is built and maintained by
\href{https://excamera.com}{Excamera Labs}.


\newpage
\raggedright
\addcontentsline{toc}{section}{Index}
\renewcommand{\indexname}{Index}
\printindex

\end{document}
